

USE GD2C2024
GO


------------ Eliminación de funciones    ------------------

IF OBJECT_ID('REINUS.CALCULAR_TURNO') IS NOT NULL
DROP FUNCTION REINUS.CALCULAR_TURNO

IF OBJECT_ID('REINUS.CALCULAR_HORARIO') IS NOT NULL
DROP FUNCTION REINUS.CALCULAR_HORARIO
GO
IF OBJECT_ID('REINUS.CALCULAR_RANGO_ETARIO') IS NOT NULL
DROP FUNCTION REINUS.CALCULAR_RANGO_ETARIO
GO
IF OBJECT_ID('REINUS.CALCULAR_FECHA') IS NOT NULL
DROP FUNCTION REINUS.CALCULAR_FECHA
GO



------------ Eliminación de procedures    ------------------

IF OBJECT_ID('REINUS.BI_MIGRAR_D_RANGO_ETARIO','P') IS NOT NULL
DROP PROCEDURE  REINUS.BI_MIGRAR_D_RANGO_ETARIO

IF OBJECT_ID('REINUS.BI_MIGRAR_D_TURNOS','P') IS NOT NULL
DROP PROCEDURE  REINUS.BI_MIGRAR_D_TURNOS

IF OBJECT_ID('REINUS.BI_MIGRAR_D_UBICACION','P') IS NOT NULL
DROP PROCEDURE  REINUS.BI_MIGRAR_D_UBICACION

IF OBJECT_ID('REINUS.BI_MIGRAR_D_SUCURSAL','P') IS NOT NULL
DROP PROCEDURE  REINUS.BI_MIGRAR_D_SUCURSAL

IF OBJECT_ID('REINUS.BI_MIGRAR_D_TIEMPO','P') IS NOT NULL
DROP PROCEDURE  REINUS.BI_MIGRAR_D_TIEMPO

IF OBJECT_ID('REINUS.BI_MIGRAR_CATEGORIA','P') IS NOT NULL
DROP PROCEDURE  REINUS.BI_MIGRAR_CATEGORIA
GO

IF OBJECT_ID('REINUS.BI_MIGRAR_SUBCATEGORIA','P') IS NOT NULL
DROP PROCEDURE  REINUS.BI_MIGRAR_SUBCATEGORIA
GO

IF OBJECT_ID('REINUS.BI_MIGRAR_VENTAS','P') IS NOT NULL
DROP PROCEDURE  REINUS.BI_MIGRAR_VENTAS

IF OBJECT_ID('REINUS.BI_MIGRAR_D_MEDIO_PAGO','P') IS NOT NULL
DROP PROCEDURE  REINUS.BI_MIGRAR_D_MEDIO_PAGO

IF OBJECT_ID('REINUS.BI_MIGRAR_D_CAJAS','P') IS NOT NULL
DROP PROCEDURE  REINUS.BI_MIGRAR_D_CAJAS

IF OBJECT_ID('REINUS.BI_MIGRAR_H_VENTAS','P') IS NOT NULL
DROP PROCEDURE  REINUS.BI_MIGRAR_H_VENTAS
GO

IF OBJECT_ID('REINUS.BI_MIGRAR_H_PAGOS','P') IS NOT NULL
DROP PROCEDURE  REINUS.BI_MIGRAR_H_PAGOS
GO

IF OBJECT_ID('REINUS.BI_MIGRAR_H_PROMOCIONES','P') IS NOT NULL
DROP PROCEDURE  REINUS.BI_MIGRAR_H_PROMOCIONES
GO

IF OBJECT_ID('REINUS.BI_MIGRAR_H_ENVIOS','P') IS NOT NULL
DROP PROCEDURE  REINUS.BI_MIGRAR_H_ENVIOS
GO

------------ Eliminación de views ------------------

IF OBJECT_ID('REINUS.VIEW_1','V') IS NOT NULL
DROP VIEW  REINUS.VIEW_1
GO


IF OBJECT_ID('REINUS.VIEW_2','V') IS NOT NULL
DROP VIEW  REINUS.VIEW_2
GO


IF OBJECT_ID('REINUS.VIEW_3','V') IS NOT NULL
DROP VIEW  REINUS.VIEW_3
GO


IF OBJECT_ID('REINUS.VIEW_4','V') IS NOT NULL
DROP VIEW  REINUS.VIEW_4
GO

IF OBJECT_ID('REINUS.VIEW_5','V') IS NOT NULL
DROP VIEW  REINUS.VIEW_5
GO

IF OBJECT_ID('REINUS.VIEW_6','V') IS NOT NULL
DROP VIEW  REINUS.VIEW_6
GO

IF OBJECT_ID('REINUS.VIEW_7','V') IS NOT NULL
DROP VIEW  REINUS.VIEW_7
GO

IF OBJECT_ID('REINUS.VIEW_8','V') IS NOT NULL
DROP VIEW  REINUS.VIEW_8
GO

IF OBJECT_ID('REINUS.VIEW_9','V') IS NOT NULL
DROP VIEW  REINUS.VIEW_9
GO

IF OBJECT_ID('REINUS.VIEW_10','V') IS NOT NULL
DROP VIEW  REINUS.VIEW_10
GO

IF OBJECT_ID('REINUS.VIEW_11','V') IS NOT NULL
DROP VIEW  REINUS.VIEW_11
GO

IF OBJECT_ID('REINUS.VIEW_12','V') IS NOT NULL
DROP VIEW  REINUS.VIEW_12
GO


IF OBJECT_ID('REINUS.BI_H_VENTAS','U') IS NOT NULL
    DROP TABLE REINUS.BI_H_VENTAS;

IF OBJECT_ID('REINUS.BI_H_PAGOS','U') IS NOT NULL
    DROP TABLE REINUS.BI_H_PAGOS;

IF OBJECT_ID('REINUS.BI_H_ENVIOS','U') IS NOT NULL
    DROP TABLE REINUS.BI_H_ENVIOS;

IF OBJECT_ID('REINUS.BI_D_RANGO_ETARIO','U') IS NOT NULL
    DROP TABLE REINUS.BI_D_RANGO_ETARIO;

IF OBJECT_ID('REINUS.BI_D_RANGO_HORARIO','U') IS NOT NULL
    DROP TABLE REINUS.BI_D_RANGO_HORARIO;

IF OBJECT_ID('REINUS.BI_D_UBICACION','U') IS NOT NULL
    DROP TABLE REINUS.BI_D_UBICACION;
GO
IF OBJECT_ID('REINUS.BI_D_MEDIO_PAGO','U') IS NOT NULL
    DROP TABLE REINUS.BI_D_MEDIO_PAGO;
	GO
IF OBJECT_ID('REINUS.BI_D_RUBRO','U') IS NOT NULL
    DROP TABLE REINUS.BI_D_RUBRO;
GO

IF OBJECT_ID('REINUS.BI_D_SUBRUBRO','U') IS NOT NULL
    DROP TABLE REINUS.BI_D_SUBRUBRO;

GO



	CREATE FUNCTION REINUS.CALCULAR_RANGO_ETARIO (@FECHA_NACIMIENTO DATE)
RETURNS SMALLINT
AS
BEGIN
    DECLARE @ANIOS INT = DATEDIFF(YEAR, @FECHA_NACIMIENTO, GETDATE())
    DECLARE @RES SMALLINT
    IF @ANIOS < 25
        SET @RES = 1
    ELSE
        IF @ANIOS BETWEEN 25 AND 35
            SET @RES = 2
        ELSE
            IF @ANIOS BETWEEN 35 AND 50
                SET @RES = 3
            ELSE
                IF @ANIOS > 50
                    SET @RES = 4
                ELSE
                    SET @RES = 5
    RETURN @RES
END
GO
CREATE FUNCTION REINUS.CALCULAR_HORARIO (@HORARIO DATETIME)
RETURNS SMALLINT
AS
BEGIN
    DECLARE @HORA INT = DATEPART(HOUR, @HORARIO)
    DECLARE @RES SMALLINT
    IF @HORA BETWEEN 0 AND 6
            SET @RES = 1
        ELSE
            IF @HORA BETWEEN 6 AND 12
                SET @RES = 2
            ELSE IF  @HORA BETWEEN 12 AND 18
                SET @RES = 3
			ELSE
			SET @RES =4
				 

    RETURN @RES
END
GO

CREATE FUNCTION REINUS.CALCULAR_FECHA(@FECHA DATETIME)
RETURNS SMALLINT
AS
BEGIN
DECLARE @ANIO INT
DECLARE @CUATRIMESTRE INT
DECLARE @MES INT

SELECT @ANIO = YEAR(@FECHA), @CUATRIMESTRE = DATEPART(QUARTER,@FECHA), @MES = MONTH(@FECHA)
RETURN (select TIEMPO_ID from BI_D_TIEMPO
where
@ANIO = TIEMPO_ANIO AND
@CUATRIMESTRE = TIEMPO_CUATRIMESTRE AND
@MES = TIEMPO_MES
)
END
GO



CREATE PROCEDURE REINUS.BI_MIGRAR_D_RANGO_ETARIO
AS
BEGIN
    INSERT INTO BI_D_RANGO_ETARIO(RANGO_ETARIO_DESCRIPCION)
    VALUES ('<25')
    INSERT INTO BI_D_RANGO_ETARIO(RANGO_ETARIO_DESCRIPCION)
    VALUES ('25-35')
    INSERT INTO BI_D_RANGO_ETARIO(RANGO_ETARIO_DESCRIPCION)
    VALUES ('35-50')
    INSERT INTO BI_D_RANGO_ETARIO(RANGO_ETARIO_DESCRIPCION)
    VALUES ('>50')
    INSERT INTO BI_D_RANGO_ETARIO(RANGO_ETARIO_DESCRIPCION)
    VALUES ('DESCONOCIDO')
END
GO



CREATE PROCEDURE REINUS.BI_MIGRAR_D_RANGO_HORARIO
AS
BEGIN
    INSERT INTO BI_D_RANGO_HORARIO(RANGO_HRAARIO_DESCRIPCION)
    VALUES ('00:00-06:00')
    INSERT INTO BI_D_RANGO_HORARIO(RANGO_HORARIO_DESCRIPCION)
    VALUES ('06:00-12:00')
    INSERT INTO BI_D_RANGO_HORARIO(RANGO_HORARIO_DESCRIPCION)
    VALUES ('12:00-18:00')
    INSERT INTO BI_D_RANGO_HORARIO(RANGO_HORARIO_DESCRIPCION)
    VALUES ('18:00-24:00')
   
END
GO

/*
CREATE TABLE REINUS.Subrubro (
ID_SUBRUBRO INTEGER IDENTITY(1,1) NOT NULL,
RUBRO_ID INTEGER NOT NULL ,--FK
PRODUCTO_SUB_RUBRO NVARCHAR(50)
)

CREATE TABLE REINUS.Rubro (--CRAEDA CON EXITO
ID_RUBRO INTEGER IDENTITY(1,1) NOT NULL,
PRODUCTO_RUBRO_DESCRIPCION  NVARCHAR(50)
)*/

-- Migración RUBRO
CREATE PROCEDURE REINUS.BI_MIGRAR_RUBRO
AS
BEGIN
INSERT INTO BI_D_RUBRO (PRODUCTO_RUBRO_DESCRIPCION)
(SELECT PRODUCTO_RUBRO_DESCRIPCION   FROM REINUS.Rubro
GROUP BY PRODUCTO_RUBRO_DESCRIPCION )
END
GO
-- Migración SUBRUBRO
CREATE PROCEDURE REINUS.BI_MIGRAR_SUBRUBRO
AS
BEGIN
INSERT INTO BI_D_SUBRUBRO(RUBRO_ID,PRODUCTO_SUB_RUBRO)
(SELECT  RUBRO_ID, PRODUCTO_SUB_RUBRO FROM REINUS.Subrubro
GROUP BY  RUBRO_ID, PRODUCTO_SUB_RUBRO)
END
GO
